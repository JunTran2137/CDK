acm_certs:
  main:
    name: "main-cert"
    domain_name: "juntran.id.vn"
    subject_alternative_names: ["*.juntran.id.vn"]

    allow_export: false
    validation: "from_dns"
    key_algorithm: "RSA_2048"

vpcs:
  main:
    name: "main-vpc"
    cidr: "10.1.0.0/16"
    ipv6_addresses: null
    instance_tenancy: "DEFAULT"

    availability_zones: ["ap-southeast-1a", "ap-southeast-1b"]

    subnet_configuration:
      - name: "public"
        cidr_mask: 24
        subnet_type: "PUBLIC"
      - name: "private"
        cidr_mask: 24
        subnet_type: "PRIVATE_WITH_EGRESS"

    nat_gateways: 1
    gateway_endpoints: null
    enable_dns_hostnames: true
    enable_dns_support: true

sgs:
  ec2:
    name: "ec2-sg"
    description: "Security group for EC2 instances"
    vpc_key: "main"

    ingress_rules: [["0.0.0.0/0", 22]]
    egress_rules: [["0.0.0.0/0", "all"]]

  alb:
    name: "alb-sg"
    description: "Security group for ALB"
    vpc_key: "main"

    ingress_rules: [["0.0.0.0/0", 80], ["0.0.0.0/0", 443]]
    egress_rules: [["0.0.0.0/0", "all"]]

sg_rules:
  - source_sg_key: "alb"
    sg_key: "ec2"
    description: "Allow HTTP traffic from ALB to EC2"

    type: "ingress"
    protocol: "TCP"
    from_port: 80
    to_port: 80

ec2_instances:
  main:
    name: "main-instance"
    ami: "ami-00d8fc944fb171e29"
    instance_type: "t3a.small"
    key_pair: "main-key"

    vpc_key: "main"
    associate_public_ip_address: true
    sg_key: "ec2"

    block_devices:
      - device_name: "/dev/sda1"
        volume_size: 10
        volume_type: "GP3"
        iops: 3000
        throughput: 125
        delete_on_termination: true
        encrypted: true
        kms_key_id: "alias/aws/ebs"

    user_data: |
      #!/bin/bash
      apt update -y

      bash -c "$(curl --fail --show-error --silent --location https://raw.githubusercontent.com/IamCarron/DVWA-Script/main/Install-DVWA.sh)"

albs:
  main:
    name: "main-alb"
    internet_facing: true
    ip_address_type: "IPV4"

    vpc_key: "main"
    sg_key: "alb"

    target_groups:
      main:
        target_type: "INSTANCE"
        name: "main-tg"
        protocol: "HTTP"
        port: 80
        ip_address_type: "IPV4"
        vpc_key: "main"
        protocol_version: "HTTP1"

        health_check:
          enabled: true
          protocol: "HTTP"
          path: "/"
          port: "traffic-port"
          healthy_threshold: 5
          unhealthy_threshold: 2
          timeout: 5
          interval: 30
          matcher: "200"

        targets:
          - ec2_key: "main"
            port: 80

    listeners:
      http:
        protocol: "HTTP"
        port: 80

        redirect:
          protocol: "HTTPS"
          port: "443"
          permanent: true

      https:
        protocol: "HTTPS"
        port: 443
        acm_key: "main"
        forward: { target_group_key: "main" }

waf_web_acls:
  main:
    scope: "REGIONAL"
    name: "main-web-acl"
    description: "Main Web ACL"
    alb_key: "main"

    visibility_config:
      cloudwatch_metrics_enabled: false
      metric_name: "Main-Web-ACL-Metrics"
      sampled_requests_enabled: true

    default_action: "allow"
    token_domains: ["test.juntran.id.vn"]
    log_destination_configs: []

    rules:
      - name: "Anti-Command-Injection"
        action: "block"
        priority: 1

        and_statement:
          statements:
            not_statement:
              regex_match_statement:
                field_to_match:
                  body:
                    oversize_handling: "CONTINUE"
                regex_string: '^[^&;|\-$()`\n\t]*(&Submit|&Login|&user_token|&password|&seclev_submit)'
                text_transformations:
                  priority: 0
                  type: "URL_DECODE"

            byte_match_statement:
              field_to_match:
                method: {}
              search_string: "POST"
              text_transformations:
                priority: 0
                type: "NONE"
              positional_constraint: "EXACTLY"

        visibility_config:
          cloudwatch_metrics_enabled: false
          metric_name: "AWS-Anti-Command-Injection"
          sampled_requests_enabled: true
